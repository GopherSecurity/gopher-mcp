cmake_minimum_required(VERSION 3.16)
project(auth_tests_minimal)

# Use C++17 for tests (even though library is C++11)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Find required packages
find_package(OpenSSL REQUIRED)
find_package(CURL REQUIRED)
find_package(Threads REQUIRED)

# Try to use system GTest first
find_package(GTest QUIET)
if(NOT GTest_FOUND)
    # Only download GTest if not found on system
    message(STATUS "GTest not found on system, downloading...")
    include(FetchContent)
    FetchContent_Declare(
        googletest
        URL https://github.com/google/googletest/archive/refs/tags/v1.14.0.tar.gz
        DOWNLOAD_EXTRACT_TIMESTAMP TRUE
    )
    set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
    FetchContent_MakeAvailable(googletest)
endif()

# Include directories
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}/../../include
    ${OPENSSL_INCLUDE_DIR}
    ${CURL_INCLUDE_DIRS}
)

# Link to the standalone auth library
link_directories(${CMAKE_CURRENT_SOURCE_DIR}/../../build-auth-only)

# Helper function to add auth test
function(add_auth_test test_name)
    add_executable(${test_name} ${test_name}.cc)
    target_link_libraries(${test_name}
        gopher_mcp_auth
        ${OPENSSL_LIBRARIES}
        ${CURL_LIBRARIES}
        Threads::Threads
        GTest::gtest
        GTest::gtest_main
    )
    add_test(NAME ${test_name} COMMAND ${test_name})
endfunction()

# Add all auth tests
enable_testing()
add_auth_test(test_auth_types)
add_auth_test(benchmark_jwt_validation)
add_auth_test(benchmark_crypto_optimization)
add_auth_test(benchmark_network_optimization)
add_auth_test(test_keycloak_integration)
add_auth_test(test_mcp_inspector_flow)
add_auth_test(test_complete_integration)
